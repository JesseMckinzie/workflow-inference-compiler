# This is based on the excellent gromacs CWL tutorial http://mmb.irbbarcelona.org/webdev/slim/biobb/public/availability/tutorials/cwl
# The `in` tags are superfluous, but retained for now to simplify implementation.
# Limit nsteps to 1000 for demo / development.
steps:
  - pdb:
      in:
        output_pdb_path: tutorial.pdb
        config: '{"pdb_code" : "1aki"}'
  - fix_side_chain:
# Setup
  - pdb2gmx:
  - editconf:
      in:
        config: '{"box_type": "cubic","distance_to_molecule": 1.0}'
  - solvate:
  - grompp:
      in:
        config: '{"mdp": {"integrator":"steep"}}'
  - genion:
      in:
        config: '{"neutral": "True"}'
# Minimization
  - grompp:
      in:
        config: '{"mdp": {"integrator":"steep", "rvdw":"1.4", "rcoulomb":"1.4", "nsteps":"100", "emtol":"500", "nstenergy":"1"}}'
        output_tpr_path: 'min.tpr'  # Explicitly specify filename for future reference.
  - mdrun:
  - gmx_energy:
      in:
        config: '{"terms":  ["Potential"]}'
        output_xvg_path: 'energy_min.xvg'
# NVT equil
  - grompp:
      in:
        config: '{"mdp": {"integrator":"sd", "rvdw":"1.0", "rcoulomb":"1.0", "coulombtype":"pme", "nsteps":"1000", "dt":0.002, "tc-grps":"system", "ref-t":"300", "tau-t":"2", "constraints":"h-bonds", "nstxout":"1000", "define":"-DPOSRES"}}'
  - mdrun:
  - gmx_energy:
      in:
        config: '{"terms":  ["Temperature"]}'
        output_xvg_path: 'energy_nvt.xvg'
# NPT equil
  - grompp:
      in:
        config: '{"mdp": {"integrator":"sd", "rvdw":"1.0", "rcoulomb":"1.0", "coulombtype":"pme", "nsteps":"1000", "dt":0.002, "tc-grps":"system", "ref-t":"300", "tau-t":"2", "constraints":"h-bonds", "nstxout":"1000", "pcoupl":"Berendsen", "tau-p":"1", "ref-p":"1", "compressibility":"4.5e-5"}}'
  - mdrun:
  - gmx_energy:
      in:
        config: '{"terms":  ["Pressure","Density"]}'
        output_xvg_path: 'energy_npt.xvg'
# Production
  - grompp:
      in:
        config: '{"mdp": {"integrator":"sd", "rvdw":"1.0", "rcoulomb":"1.0", "coulombtype":"pme", "nsteps":"1000", "dt":0.002, "tc-grps":"system", "ref-t":"300", "tau-t":"2", "constraints":"h-bonds", "nstxout":"1000", "pcoupl":"Berendsen", "tau-p":"1", "ref-p":"1", "compressibility":"4.5e-5"}}'
  - mdrun:
# Trajectory Analysis
  - gmx_rms:
      in:
        config: '{"selection": "Backbone"}'
        output_xvg_path: 'rmsd_first.xvg'
  - gmx_rms:
      in:
        config: '{"selection": "Backbone"}'
        output_xvg_path: 'rmsd_exp.xvg'
        input_structure_path: 'min.tpr'  # Use structure from a specific step in the pipeline, not just the most recent step.
  - gmx_rgyr:
      in:
        config: '{"selection": "Backbone"}'
        input_structure_path: 'min.tpr'  # Use structure from a specific step in the pipeline, not just the most recent step.
  - gmx_image:
      in:
        config: '{"center_selection":"Protein","output_selection":"Protein","pbc":"mol"}'
        input_top_path: 'system.tpr'  # Workaround renaming issue
  - gmx_trjconv_str:
      in:
        config: '{"selection": "Protein"}'
        input_top_path: 'system.tpr'  # Workaround renaming issue
        input_structure_path: 'system.gro'  # Workaround renaming issue
